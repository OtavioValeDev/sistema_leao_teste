<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pedidos - Cliente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
      /* Inlined CSS from style.css */
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
      :root {
          --bg:#fff6e9;
          --card:#ffffff;
          --muted:#6b7280;
          --accent:#ff6b00;
          --accent-2:#ffd166;
          --success:#27ae60;
          --danger:#e74c3c;
          --radius:14px;
          --shadow: 0 10px 30px rgba(15,15,15,0.08);
      }

        body {
          font-family: 'Poppins', sans-serif;
          background: linear-gradient(180deg,#fff 0%, #fff6e9 100%);
      }

      /* Accessibility focus */
      :focus {
          outline: 3px solid rgba(255,107,0,0.18);
          outline-offset: 4px;
      }
      /* Product card hover effect */
      .product-card {
          transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .product-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
          width: 8px;
      }

      ::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb {
          background: #888;
          border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
          background: #555;
      }

      /* Animation for cart items */
      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .cart-item {
          animation: fadeIn 0.3s ease forwards;
      }

      /* Preferential service styles */
      .preferential-service-section {
          background: linear-gradient(45deg, #f39c12, #e67e22);
            padding: 20px;
          margin: 20px 0;
          border-radius: 10px;
            text-align: center;
          box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
      }
      .preferential-service-section h3 {
          color: white;
            margin-bottom: 10px;
            font-size: 1.5em;
      }
      .preferential-service-section p {
          color: rgba(255,255,255,0.9);
            margin-bottom: 15px;
        }
      .preferential-button {
          background: white;
          color: #e67e22;
            border: none;
          padding: 12px 25px;
          border-radius: 8px;
            cursor: pointer;
          font-size: 1.1em;
            font-weight: bold;
          transition: all 0.3s;
          box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      }
      .preferential-button:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      }


      /* Receipt modal styles */
        .receipt-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        .receipt-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

      /* Preferential receipt modal */
      .preferential-modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          z-index: 1000;
          animation: fadeIn 0.3s ease;
      }
      .preferential-content {
            position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 30px;
          border-radius: 15px;
          max-width: 500px;
          width: 90%;
            text-align: center;
          box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

    </style>
</head>
<body class="bg-gray-100">
    <main class="min-h-screen bg-gradient-to-br from-orange-50 to-blue-50 flex items-center justify-center p-4">
        <div class="w-full max-w-7xl space-y-8">
            <!-- Header -->
            <div class="text-center">
                <div class="flex justify-center items-center mb-4">
                    <span class="text-4xl">üçΩÔ∏è</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">√Årea do Cliente</h1>
                <p class="text-gray-600">Escolha seus produtos e fa√ßa seu pedido</p>
            </div>

            <!-- Content -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Products Section -->
                    <section class="lg:w-3/4">
                        <div class="controls mb-6">
                            <div class="flex gap-2 mb-4">
                                <div class="search flex items-center gap-2 p-4 rounded-xl bg-orange-50 border-2 border-orange-100 flex-1">
                                    <i data-feather="search" class="text-orange-600"></i>
                                    <input id="searchInput" class="w-full bg-transparent outline-none text-gray-700" placeholder="Pesquisar (ex: hamb√∫rguer, batata)" aria-label="Pesquisar produtos">
                                </div>
                                <button id="refreshProductsBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-xl font-medium transition duration-200 flex items-center gap-2">
                                    <i data-feather="refresh-cw" class="w-4 h-4"></i>
                                    <span>Atualizar</span>
                                </button>
                            </div>
                            <div class="categories flex gap-2 overflow-auto py-2">
                                <!-- Categories will be populated by JS -->
                            </div>
                        </div>
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">üçΩÔ∏è Escolha seus Produtos</h2>
                        <div id="productsContainer">
                            <!-- Products loading state -->
                            <div class="text-center py-12 text-gray-500" id="productsLoadingState">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto mb-4"></div>
                                Carregando produtos...
                            </div>

                            <!-- Products grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden" id="productsGrid">
                                <!-- Products will be loaded here -->
                            </div>

                            <!-- Error state -->
                            <div class="hidden text-center py-12" id="productsErrorState">
                                <div class="text-red-500 mb-4">
                                    <i data-feather="alert-circle" class="w-16 h-16 mx-auto mb-4"></i>
                                    <h3 class="text-xl font-bold mb-2">Erro ao carregar produtos</h3>
                                    <p class="mb-4">N√£o foi poss√≠vel carregar o card√°pio.</p>
                                    <button onclick="retryLoadProducts()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-medium transition duration-200">
                                        Tentar Novamente
                                    </button>
                                </div>
                            </div>

                            <!-- Empty state -->
                            <div class="hidden text-center py-12 text-gray-500" id="productsEmptyState">
                                <i data-feather="package" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                                <h3 class="text-xl font-bold mb-2">Nenhum produto dispon√≠vel</h3>
                                <p>O card√°pio est√° vazio no momento.</p>
                            </div>
                        </div>
                    </section>

                    <!-- Cart Section -->
                    <section class="lg:w-1/4">
                        <div class="bg-gray-50 rounded-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-xl font-bold text-gray-800">üõí Seu Pedido</h2>
                                <i data-feather="shopping-cart" class="text-gray-600"></i>
                            </div>
                            <div id="cart-items" class="mb-4">
                                <!-- Cart items will appear here -->
                                <p class="text-gray-500 italic" id="empty-cart-message">Seu carrinho est√° vazio</p>
                            </div>
                            <div class="border-t border-gray-200 pt-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-medium">Subtotal:</span>
                                    <span class="font-bold" id="subtotal">R$0,00</span>
                                </div>
                                <div class="flex justify-between items-center mb-4">
                                    <span class="font-medium">Tax (10%):</span>
                                    <span class="font-bold" id="tax">R$0,00</span>
                                </div>
                                <div class="flex justify-between items-center text-lg font-bold mb-6">
                                    <span>Total:</span>
                                    <span id="total">R$0,00</span>
                                </div>
                                <button id="checkout-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    Finalizar Pedido
                                </button>
                            </div>
                        </div>

                        <!-- Preferential Service Section -->
                        <div class="mt-6 bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-4 rounded-xl text-center">
                            <h3 class="font-bold mb-2">‚≠ê Atendimento Preferencial</h3>
                            <p class="text-sm mb-3 opacity-90">Precisa de atendimento r√°pido?</p>
                            <button id="preferentialButton" class="bg-white text-orange-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition duration-200">
                                üöÄ Solicitar
                            </button>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <custom-footer></custom-footer>

    <!-- Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Confirma√ß√£o do Pedido</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x"></i>
                </button>
            </div>
            <p class="mb-4 text-gray-600">Obrigado pelo seu pedido! Sua comida estar√° pronta em breve.</p>
            <div id="order-summary" class="mb-6">
                <!-- Order summary will appear here -->
            </div>
            <button onclick="processOrder()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium transition duration-200 mr-2">
                Confirmar Pedido
            </button>
            <button onclick="closeModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-medium transition duration-200">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="receipt-modal">
        <div class="receipt-content">
            <span class="close-button" onclick="closeReceiptModal()">&times;</span>

            <div class="receipt-header">
                <h2>üçî RESTAURANTE</h2>
                <p>Pedido Realizado com Sucesso!</p>
            </div>

            <div class="receipt-number" id="receiptNumber">
                #0000
            </div>

            <div class="receipt-details" id="receiptDetails">
                <!-- Receipt details will be populated here -->
            </div>

            <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #f0c674;">
                <strong>üì¢ Importante:</strong><br>
                Anote seu n√∫mero de chamada e aguarde ser chamado no balc√£o.
            </div>

            <button class="print-button" onclick="window.print()">
                üñ®Ô∏è Imprimir Recibo
            </button>
        </div>
    </div>

    <script>
      // Inlined navbar component
      class CustomNavbar extends HTMLElement {
        connectedCallback() {
          this.attachShadow({ mode: 'open' });
          this.shadowRoot.innerHTML = `
            <style>
              nav {
                background-color: #111;
                color: white;
                padding: 1rem 2rem;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
              }

              .nav-container {
                max-width: 1200px;
                margin: 0 auto;
                display: flex;
                justify-content: space-between;
                align-items: center;
              }

              .logo {
                font-size: 1.5rem;
                font-weight: bold;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              }
              .logo-icon {
                color: #ff6b00;
              }
              .cart-icon {
                position: relative;
                cursor: pointer;
              }

              .cart-count {
                position: absolute;
                top: -8px;
                right: -8px;
                background-color: #f97316;
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 12px;
              }
            </style>
            <nav>
              <div class="nav-container">
                <div class="logo">
                  <i data-feather="coffee" class="logo-icon"></i>
                  <span>Sistema de Gest√£o - Senhor Le√£o</span>
                </div>
                <div class="cart-icon">
                  <i data-feather="shopping-cart"></i>
                  <span class="cart-count" id="nav-cart-count">0</span>
                </div>
              </div>
            </nav>
          `;

          document.addEventListener('cartUpdated', (e) => {
            const count = e.detail.count;
            this.shadowRoot.getElementById('nav-cart-count').textContent = count;
          });
        }
      }
      customElements.define('custom-navbar', CustomNavbar);
      // Inlined footer component
      class CustomFooter extends HTMLElement {
        connectedCallback() {
          this.attachShadow({ mode: 'open' });
          this.shadowRoot.innerHTML = `
            <style>
              footer {
                background-color: #111;
                color: white;
                padding: 2rem;
                margin-top: 4rem;
              }

              .footer-container {
                max-width: 1200px;
                margin: 0 auto;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 2rem;
              }

              .footer-section h3 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
                color: #f97316;
              }

              .footer-section ul {
                list-style: none;
                padding: 0;
                margin: 0;
              }

              .footer-section li {
                margin-bottom: 0.5rem;
              }

              .footer-section a {
                color: #ccc;
                text-decoration: none;
                transition: color 0.2s;
              }

              .footer-section a:hover {
                color: white;
              }

              .social-icons {
                display: flex;
                gap: 1rem;
              }

              .social-icons a {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 36px;
                height: 36px;
                background-color: #333;
                border-radius: 50%;
                color: white;
                transition: background-color 0.2s;
              }

              .social-icons a:hover {
                background-color: #f97316;
              }

              .copyright {
                text-align: center;
                margin-top: 3rem;
                padding-top: 1rem;
                border-top: 1px solid #333;
                color: #999;
                font-size: 0.9rem;
              }
            </style>
            
          `;
        }
      }
      customElements.define('custom-footer', CustomFooter);

        // Global variables
        let availableProducts = [];
        let cart = [];
        // Use absolute URLs to avoid routing conflicts with static files
        const API_BASE = window.location.protocol + '//' + window.location.host + '/api/products';
        const RECIBOS_API = window.location.protocol + '//' + window.location.host + '/recibos';


      // Initialize the app when DOM is loaded
      document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ DOM carregado, inicializando app...');
        try {
          feather.replace();
          init();
        } catch (error) {
          console.error('‚ùå Erro na inicializa√ß√£o:', error);
        }
      });

      async function init() {
          console.log('üöÄ Iniciando aplica√ß√£o cliente...');

          try {
            console.log('üé® Renderizando componentes b√°sicos...');
            renderCategories();
            renderCart();
            setupEventListeners();
            setupSearch();

            console.log('üì¶ Carregando produtos...');
            await loadProducts();

            console.log('‚úÖ Inicializa√ß√£o conclu√≠da com sucesso!');
          } catch (error) {
            console.error('‚ùå Erro na inicializa√ß√£o:', error);
            alert('Erro ao inicializar a aplica√ß√£o: ' + error.message);
          }
      }


        function setupEventListeners() {
            document.getElementById('checkout-btn').addEventListener('click', showOrderConfirmation);
            document.getElementById('preferentialButton').addEventListener('click', requestPreferentialService);
            document.getElementById('refreshProductsBtn').addEventListener('click', refreshProducts);
        }

        // Product loading state management
        function setProductsState(state) {
            console.log('üé≠ Mudando estado dos produtos para:', state);

            const loadingState = document.getElementById('productsLoadingState');
            const grid = document.getElementById('productsGrid');
            const errorState = document.getElementById('productsErrorState');
            const emptyState = document.getElementById('productsEmptyState');

            console.log('üìç Elementos encontrados:', {
                loadingState: !!loadingState,
                grid: !!grid,
                errorState: !!errorState,
                emptyState: !!emptyState
            });

            // Hide all states first
            [loadingState, grid, errorState, emptyState].forEach(el => {
                if (el) el.classList.add('hidden');
            });

            // Show the requested state
            switch (state) {
                case 'loading':
                    if (loadingState) loadingState.classList.remove('hidden');
                    console.log('‚úÖ Estado loading ativado');
                    break;
                case 'loaded':
                    if (grid) grid.classList.remove('hidden');
                    console.log('‚úÖ Estado loaded ativado');
                    break;
                case 'error':
                    if (errorState) errorState.classList.remove('hidden');
                    console.log('‚úÖ Estado error ativado');
                    break;
                case 'empty':
                    if (emptyState) emptyState.classList.remove('hidden');
                    console.log('‚úÖ Estado empty ativado');
                    break;
                default:
                    console.warn('‚ö†Ô∏è Estado desconhecido:', state);
            }

            feather.replace();
        }

        // Retry loading products
        function retryLoadProducts() {
            loadProducts();
        }

        // Load products from API
        async function loadProducts() {
            // ‚Üë Fun√ß√£o ass√≠ncrona para carregar produtos da API
            //   async permite usar await dentro da fun√ß√£o
            console.log('üîÑ Iniciando carregamento de produtos da API:', API_BASE);
            // ‚Üë Log para debug mostrando qual API est√° sendo chamada
            console.log('üåê URL completa constru√≠da:', API_BASE);
            // ‚Üë Mostra a URL final que ser√° usada
            setProductsState('loading');
            // ‚Üë Muda o estado da interface para "carregando"
            //   Mostra spinner e esconde produtos

            try {
                // ‚Üë Bloco try-catch para tratar erros da requisi√ß√£o
                console.log('üì§ Fazendo requisi√ß√£o fetch...');
                // ‚Üë Log indicando que vai fazer a requisi√ß√£o HTTP
                const fetchUrl = API_BASE;
                // ‚Üë Define a URL para fazer a requisi√ß√£o
                console.log('üîó URL de fetch:', fetchUrl);
                // ‚Üë Log da URL final

                const response = await fetch(fetchUrl, {
                    // ‚Üë Faz requisi√ß√£o HTTP ass√≠ncrona usando fetch API
                    //   await espera a resposta chegar
                    method: 'GET',
                    // ‚Üë M√©todo HTTP GET para buscar dados
                    headers: {
                        // ‚Üë Cabe√ßalhos da requisi√ß√£o
                        'Accept': 'application/json'
                        // ‚Üë Informa que aceita resposta em formato JSON
                    }
                });

                console.log('üì° Resposta da API recebida:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    url: response.url,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Resposta de erro:', errorText);
                    console.error('‚ùå Headers de erro:', Object.fromEntries(response.headers.entries()));
                    throw new Error(`Erro HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }

                const responseText = await response.text();
                console.log('üìÑ Texto da resposta:', responseText.substring(0, 500) + (responseText.length > 500 ? '...' : ''));

                try {
                    availableProducts = JSON.parse(responseText);
                    console.log('‚úÖ JSON parseado com sucesso. Produtos carregados:', availableProducts.length, 'itens');
                } catch (parseError) {
                    console.error('‚ùå Erro ao fazer parse JSON:', parseError);
                    console.error('‚ùå Conte√∫do que falhou no parse:', responseText);
                    throw parseError;
                }

                // Debug: mostrar produtos no console do navegador
                if (availableProducts.length > 0) {
                    console.log('üîç Primeiro produto:', availableProducts[0]);
                    console.log('üîç √öltimo produto:', availableProducts[availableProducts.length - 1]);
                } else {
                    console.log('‚ö†Ô∏è Nenhum produto encontrado na resposta');
                }

                if (availableProducts.length === 0) {
                    console.log('üì≠ Definindo estado empty');
                    setProductsState('empty');
                } else {
                    console.log('üé® Renderizando produtos e definindo estado loaded');
                    renderProducts();
                    setProductsState('loaded');
                }

            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos:', error);
                console.error('‚ùå Stack trace:', error.stack);

                // Try fallback method
                console.log('üîÑ Tentando m√©todo alternativo...');
                const fallbackSuccess = await loadProductsFallback();

                if (!fallbackSuccess) {
                    console.log('‚ùå Fallback tamb√©m falhou, definindo estado error');
                    setProductsState('error');
                }
            }
        }

        // Refresh products manually
        async function refreshProducts() {
            const btn = document.getElementById('refreshProductsBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i data-feather="refresh-cw" class="w-4 h-4 animate-spin"></i><span>Carregando...</span>';
            feather.replace();

            try {
                await loadProducts();
                // Temporarily show success state
                btn.innerHTML = '<i data-feather="check" class="w-4 h-4"></i><span>Atualizado!</span>';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    feather.replace();
                }, 1500);
            } catch (error) {
                console.error('‚ùå Erro no refresh manual:', error);
                btn.innerHTML = '<i data-feather="x" class="w-4 h-4"></i><span>Erro</span>';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    feather.replace();
                }, 2000);
            }
        }

        // Alternative product loading method (fallback)
        async function loadProductsFallback() {
            console.log('üîÑ Tentando carregamento alternativo de produtos...');

            try {
                // Try the cors-test endpoint which has more permissive headers
                const response = await fetch(API_BASE + '/cors-test', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
                }

                const products = await response.json();
                console.log('‚úÖ Produtos carregados via fallback:', products.length, 'itens');

                availableProducts = products;
                if (products.length === 0) {
                    setProductsState('empty');
                } else {
                    renderProducts();
                    setProductsState('loaded');
                }
                return true;

            } catch (error) {
                console.error('‚ùå Fallback tamb√©m falhou:', error);
                return false;
            }
        }

      function renderProducts(filteredProducts = availableProducts) {
          console.log('üé® Renderizando produtos:', filteredProducts.length, 'itens');
          console.log('üìã Produtos a renderizar:', filteredProducts);

          const productsGrid = document.getElementById('productsGrid');

          if (!productsGrid) {
              console.error('‚ùå Elemento productsGrid n√£o encontrado!');
              console.error('‚ùå Elementos dispon√≠veis:', {
                  productsGrid: document.getElementById('productsGrid'),
                  productsLoadingState: document.getElementById('productsLoadingState'),
                  productsErrorState: document.getElementById('productsErrorState'),
                  productsEmptyState: document.getElementById('productsEmptyState')
              });
              return;
          }

          productsGrid.innerHTML = '';

          if (filteredProducts.length === 0) {
              console.log('üì≠ Nenhum produto para renderizar');
              productsGrid.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum produto encontrado na busca.</div>';
              return;
          }

          filteredProducts.forEach(product => {
              const productCard = document.createElement('div');
              productCard.className = 'product-card bg-white rounded-xl p-4 shadow-md border-2 border-transparent hover:border-orange-100 transition-all';

              const priceFormatted = (product.priceInCents / 100).toFixed(2).replace('.', ',');

              productCard.innerHTML = `
                  <div class="w-full h-48 bg-gradient-to-br from-orange-100 to-orange-200 rounded-lg mb-3 flex items-center justify-center">
                      <span class="text-4xl">üçΩÔ∏è</span>
                  </div>
                  <div>
                      <h3 class="font-bold text-lg mb-2 text-gray-800">${product.name}</h3>
                      <p class="text-gray-600 text-sm mb-3">Delicioso prato do nosso card√°pio</p>
                      <div class="flex justify-between items-center">
                          <span class="text-orange-600 font-bold text-lg">R$ ${priceFormatted}</span>
                          <button onclick="addToCart(${product.id})"
                                  class="bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg font-medium transition duration-200">
                              Adicionar
                          </button>
                      </div>
                  </div>
              `;

              productsGrid.appendChild(productCard);
          });
      }

      function renderCategories() {
          const categoriesContainer = document.querySelector('.categories');
          // Como os produtos n√£o t√™m categoria definida na API, vamos criar uma categoria padr√£o
          const uniqueCategories = ['Lanches', 'Bebidas', 'Por√ß√µes'];
          categoriesContainer.innerHTML = '';
          uniqueCategories.forEach(category => {
              const chip = document.createElement('button');
              chip.className = 'chip px-4 py-2 rounded-full bg-orange-50 text-orange-600 font-medium text-sm';
              chip.textContent = category;
              chip.onclick = () => filterByCategory(category);
              categoriesContainer.appendChild(chip);
          });
          const allChip = document.createElement('button');
          allChip.className = 'chip px-4 py-2 rounded-full bg-orange-600 text-white font-medium text-sm';
          allChip.textContent = 'Todos';
          allChip.onclick = () => renderProducts();
          categoriesContainer.prepend(allChip);
      }

      function filterByCategory(category) {
          // Como os produtos n√£o t√™m categoria definida, vamos mostrar todos por enquanto
          // Futuramente podemos adicionar categorias aos produtos na API
          renderProducts(availableProducts);
      }

      function setupSearch() {
          const searchInput = document.getElementById('searchInput');
          searchInput.addEventListener('input', (e) => {
              const term = e.target.value.toLowerCase();
              const filtered = availableProducts.filter(p =>
                  p.name.toLowerCase().includes(term)
              );
              renderProducts(filtered);
          });
        }

        // Product selection functions
        function selectProduct(productId) {
            const product = availableProducts.find(p => p.id === productId);
            if (!product) return;

            const quantity = getProductQuantity(productId);
            if (quantity > 0) {
                addToCart(product, quantity);
                resetProductQuantity(productId);
                updateProductCard(productId, false);
            }
        }

        function increaseQuantity(productId) {
            const qtyElement = document.getElementById(`qty-${productId}`);
            const currentQty = parseInt(qtyElement.textContent);
            qtyElement.textContent = currentQty + 1;
            updateProductCard(productId, true);
        }

        function decreaseQuantity(productId) {
            const qtyElement = document.getElementById(`qty-${productId}`);
            const currentQty = parseInt(qtyElement.textContent);
            if (currentQty > 0) {
                qtyElement.textContent = currentQty - 1;
                updateProductCard(productId, currentQty > 1);
            }
        }

        function getProductQuantity(productId) {
            const qtyElement = document.getElementById(`qty-${productId}`);
            return parseInt(qtyElement.textContent);
        }

        function resetProductQuantity(productId) {
            document.getElementById(`qty-${productId}`).textContent = '0';
        }

        function updateProductCard(productId, isSelected) {
            const card = document.querySelector(`[data-id="${productId}"]`);
            if (isSelected) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        }

        function addToCart(productId) {
            const product = availableProducts.find(p => p.id === productId);
            if (!product) return;
            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    productId: product.id,
                    name: product.name,
                    price: product.priceInCents,
                    quantity: 1
                });
            }
            renderCart();
            console.log(`${product.name} adicionado ao carrinho!`);
        }

        function renderCart() {
            const cartItems = document.getElementById('cart-items');
            const emptyCartMessage = document.getElementById('empty-cart-message');
            const checkoutBtn = document.getElementById('checkout-btn');
            cartItems.innerHTML = '';
            if (cart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                checkoutBtn.disabled = true;
            } else {
                emptyCartMessage.classList.add('hidden');
                checkoutBtn.disabled = false;
                cart.forEach(item => {
                    const cartItem = document.createElement('div');
                    cartItem.className = 'cart-item mb-3 pb-3 border-b border-gray-200';
                    cartItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium">${item.name}</h4>
                                <div class="flex items-center mt-1">
                                    <button onclick="updateQuantity(${item.productId}, ${item.quantity - 1})" class="text-gray-500 hover:text-gray-700 text-sm">
                                        <i data-feather="minus" class="w-4 h-4"></i>
                                    </button>
                                    <span class="mx-2">${item.quantity}</span>
                                    <button onclick="updateQuantity(${item.productId}, ${item.quantity + 1})" class="text-gray-500 hover:text-gray-700 text-sm">
                                        <i data-feather="plus" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="block font-medium">R$${((item.price * item.quantity) / 100).toFixed(2).replace('.', ',')}</span>
                                <button onclick="removeFromCart(${item.productId})" class="text-red-500 hover:text-red-700 text-sm mt-1">
                                    Remover
                                </button>
                            </div>
                        </div>
                    `;
                    cartItems.appendChild(cartItem);
                });
            }
            updateTotals();
            feather.replace();
            // Dispatch event for navbar cart count
            document.dispatchEvent(new CustomEvent('cartUpdated', {
                detail: { count: cart.reduce((sum, item) => sum + item.quantity, 0) }
            }));
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
            updateOrderButton();
        }

        function updateTotals() {
            // Calculate subtotal
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // Calculate tax (10%)
            const tax = subtotal * 0.1;

            // Calculate total
            const total = subtotal + tax;

            // Format currency function
            const formatCurrency = (value) => {
                return (value / 100).toFixed(2).replace('.', ',');
            };

            // Update DOM elements
            document.getElementById('subtotal').textContent = 'R$' + formatCurrency(subtotal);
            document.getElementById('tax').textContent = 'R$' + formatCurrency(tax);
            document.getElementById('total').textContent = 'R$' + formatCurrency(total);
        }

        function updateOrderButton() {
            const button = document.getElementById('checkout-btn');
            if (button) {
                button.disabled = cart.length === 0;
            }
        }

        function showOrderConfirmation() {
            if (cart.length === 0) {
                alert('Adicione pelo menos um produto ao seu pedido!');
                return;
            }

            const orderModal = document.getElementById('order-modal');
            const orderSummary = document.getElementById('order-summary');
            let summaryHTML = '<div class="mb-4">';
            cart.forEach(item => {
                summaryHTML += `
                    <div class="flex justify-between mb-1">
                        <span>${item.name} x ${item.quantity}</span>
                        <span>R$${((item.price * item.quantity) / 100).toFixed(2).replace('.', ',')}</span>
                    </div>
                `;
            });
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * 0.1;
            const total = subtotal + tax;
            summaryHTML += `</div>
                <div class="border-t border-gray-200 pt-2">
                    <div class="flex justify-between mb-1">
                        <span>Subtotal:</span>
                        <span>R$${(subtotal / 100).toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span>Taxa (10%):</span>
                        <span>R$${(tax / 100).toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="flex justify-between font-bold mt-2">
                        <span>Total:</span>
                        <span>R$${(total / 100).toFixed(2).replace('.', ',')}</span>
                    </div>
                </div>
            `;
            orderSummary.innerHTML = summaryHTML;
            orderModal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('order-modal').classList.add('hidden');
        }

        async function processOrder() {
            const checkoutBtn = document.getElementById('checkout-btn');
            const originalText = checkoutBtn.textContent;
            checkoutBtn.disabled = true;
            checkoutBtn.textContent = '‚è≥ Processando...';

            try {
                // Prepare order data
                const itens = cart.map(item => ({
                    nome: item.name,
                    quantidade: item.quantity,
                    preco: item.price
                }));

                const orderData = {
                    itens: itens,
                    observacoes: "Pedido realizado via sistema web",
                    formaPagamento: "Dinheiro"
                };

                // Send order to API
                const response = await fetch(`${RECIBOS_API}/pagar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status}`);
                }

                const receipt = await response.json();

                // Show receipt modal
                showReceiptModal(receipt);

                // Clear cart and close order modal
                cart = [];
                renderCart();
                closeModal();

            } catch (error) {
                console.error('Erro ao fazer pedido:', error);
                alert('Erro ao processar o pedido. Tente novamente.');
            } finally {
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = originalText;
            }
        }

        // Receipt modal functions
        function showReceiptModal(receipt) {
            document.getElementById('receiptNumber').textContent = `#${receipt.numeroChamada}`;

            const detailsContainer = document.getElementById('receiptDetails');
            let detailsHtml = '<div style="margin-bottom: 15px;">';

            // Order date
            if (receipt.dataCriacao) {
                const date = new Date(receipt.dataCriacao);
                detailsHtml += `<div><strong>Data:</strong> ${date.toLocaleString('pt-BR')}</div>`;
            }

            detailsHtml += '</div>';

            // Items
            detailsHtml += '<div><strong>Itens:</strong></div>';
            receipt.itens.forEach(item => {
                const subtotal = (item.quantidade * item.preco) / 100;
                detailsHtml += `
                    <div class="receipt-item">
                        <span>${item.nome} √ó ${item.quantidade}</span>
                        <span>R$ ${subtotal.toFixed(2)}</span>
                    </div>
                `;
            });

            // Total
            const total = receipt.total / 100;
            detailsHtml += `
                <div class="receipt-total">
                    <span>Total: R$ ${total.toFixed(2)}</span>
                </div>
            `;

            // Payment method
            if (receipt.formaPagamento) {
                detailsHtml += `<div style="margin-top: 10px;"><strong>Pagamento:</strong> ${receipt.formaPagamento}</div>`;
            }

            // Notes
            if (receipt.observacoes) {
                detailsHtml += `<div style="margin-top: 10px;"><strong>Observa√ß√µes:</strong> ${receipt.observacoes}</div>`;
            }

            detailsContainer.innerHTML = detailsHtml;

            // Show modal
            document.getElementById('receiptModal').style.display = 'block';
        }

        function closeReceiptModal() {
            document.getElementById('receiptModal').style.display = 'none';
        }


        // Preferential service - envia notifica√ß√£o direta para funcion√°rio
        async function requestPreferentialService() {
            const button = document.getElementById('preferentialButton');
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '‚è≥ Solicitando...';

            try {
                // Envia notifica√ß√£o simples sem pedir observa√ß√µes
                const response = await fetch(API_BASE + '/notificacao-preferencial', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ Solicita√ß√£o de atendimento preferencial enviada com sucesso!\n\nAguarde ser chamado pelo sistema de som.');
                    button.textContent = '‚úÖ Solicitado!';
                    button.disabled = true; // Desabilita ap√≥s sucesso
                } else {
                    throw new Error(result.message || 'Erro desconhecido');
                }

            } catch (error) {
                console.error('Erro ao solicitar atendimento preferencial:', error);
                alert('‚ùå Erro ao solicitar atendimento preferencial: ' + error.message);
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // Show preferential service receipt modal
        function showPreferentialReceiptModal(receipt) {
            // Create preferential modal
            const modalHtml = `
                <div id="preferentialModal" class="receipt-modal">
                    <div class="receipt-content">
                        <span class="close-button" onclick="closePreferentialModal()">&times;</span>

                        <div class="receipt-header">
                            <h2>‚≠ê ATENDIMENTO PREFERENCIAL</h2>
                            <p>Solicita√ß√£o Recebida com Prioridade!</p>
                        </div>

                        <div class="receipt-number" id="preferentialReceiptNumber">
                            #${receipt.numeroChamada}
                        </div>

                        <div class="receipt-details" id="preferentialReceiptDetails">
                            <div style="margin-bottom: 15px;">
                                <div><strong>Data:</strong> ${new Date(receipt.dataCriacao).toLocaleString('pt-BR')}</div>
                                <div><strong>Tipo:</strong> <span style="color: #e67e22; font-weight: bold;">ATENDIMENTO PREFERENCIAL</span></div>
                            </div>

                            <div><strong>Motivo:</strong></div>
                            <div style="background: #fff3cd; padding: 10px; border-radius: 6px; margin: 10px 0; border: 1px solid #f0c674;">
                                ${receipt.observacoes}
                            </div>

                            <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #f0c674;">
                                <strong>‚ö° ATEN√á√ÉO:</strong><br>
                                Seu atendimento ter√° prioridade. Anote seu n√∫mero de chamada e aguarde ser chamado(a) pelo sistema de som.
                            </div>

                            <div style="margin: 20px 0; padding: 15px; background: #d4edda; border-radius: 8px; border: 1px solid #c3e6cb;">
                                <strong>üì¢ Instru√ß√µes:</strong><br>
                                ‚Ä¢ Fique atento ao sistema de som<br>
                                ‚Ä¢ Seu n√∫mero ser√° chamado em breve<br>
                                ‚Ä¢ Dirija-se ao balc√£o quando chamado
                            </div>
                        </div>

                        <button class="print-button" onclick="window.print()">
                            üñ®Ô∏è Imprimir Comprovante
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('preferentialModal').style.display = 'block';
        }

        function closePreferentialModal() {
            const modal = document.getElementById('preferentialModal');
            if (modal) {
                modal.remove();
            }
        }

        // Setup preferential service button
        document.getElementById('preferentialButton').addEventListener('click', requestPreferentialService);

        // Close modal when clicking outside
        window.onclick = function(event) {
            const receiptModal = document.getElementById('receiptModal');
            const preferentialModal = document.getElementById('preferentialModal');

            if (event.target === receiptModal) {
                closeReceiptModal();
            }
            if (preferentialModal && event.target === preferentialModal) {
                closePreferentialModal();
            }
        }
    </script>
</body>
</html>
